{% extends "base.html" %}

{% block content %}
<header>
    <span class="eyebrow">Test Report</span>
    <h1>{{ title }}</h1>
    <div class="meta-row">
        <div class="meta-item">
            <span class="label">Project</span>
            <span>{{ project_name }}</span>
        </div>
        <div class="meta-item">
            <span class="label">Generated</span>
            <span>{{ generated_at | datetime_format }}</span>
        </div>
        {% if run_info.branch %}
        <div class="meta-item">
            <span class="label">Branch</span>
            <code>{{ run_info.branch }}</code>
        </div>
        {% endif %}
        {% if run_info.commit_hash %}
        <div class="meta-item">
            <span class="label">Commit</span>
            <code>{{ run_info.commit_hash[:8] }}</code>
        </div>
        {% endif %}
        {% if duration_ms %}
        <div class="meta-item">
            <span class="label">Duration</span>
            <span>{{ duration_ms | duration_format }}</span>
        </div>
        {% endif %}
    </div>
</header>

<!-- Stats Grid -->
<div class="stats">
    <div class="stat total">
        <span class="number">{{ total }}</span>
        <span class="desc">Total</span>
    </div>
    <div class="stat passed">
        <span class="number">{{ passed }}</span>
        <span class="desc">Passed</span>
    </div>
    <div class="stat failed">
        <span class="number">{{ failed }}</span>
        <span class="desc">Failed</span>
    </div>
    <div class="stat skipped">
        <span class="number">{{ skipped }}</span>
        <span class="desc">Skipped</span>
    </div>
</div>

<!-- Pass Rate -->
<div class="pass-rate">
    <div class="pass-rate-header">
        <span class="label">Pass Rate</span>
        <span class="value {% if pass_rate >= 80 %}good{% elif pass_rate >= 50 %}warn{% else %}bad{% endif %}">{{ "%.1f" | format(pass_rate) }}%</span>
    </div>
    <div class="bar-track">
        <div class="bar-fill {% if pass_rate >= 80 %}good{% elif pass_rate >= 50 %}warn{% else %}bad{% endif %}" style="width: {{ pass_rate }}%;"></div>
    </div>
</div>

<!-- Failed Tests -->
{% if failed_tests %}
<div class="section">
    <h2 class="section-title" style="color: var(--red-text);">
        Failed Tests
        <span class="badge" style="background: var(--red-subtle); color: var(--red-text);">{{ failed_tests | length }}</span>
    </h2>
    {% for test in failed_tests %}
    <div class="card">
        <div class="card-header">
            <span class="card-name">{{ test.test_name }}</span>
            <div class="card-meta">
                {% if test.duration_ms %}
                <span class="card-duration">{{ test.duration_ms | duration_format }}</span>
                {% endif %}
                <span class="pill failed">Failed</span>
                <span class="chevron">&#9654;</span>
            </div>
        </div>
        <div class="card-body">
            {% if test.error_message %}
            <pre class="code-block error">{{ test.error_message }}</pre>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Failure Analysis -->
{% if failure_analyses %}
<div class="section">
    <h2 class="section-title">
        Failure Analysis
        <span class="badge">{{ failure_analyses | length }}</span>
    </h2>
    <p class="section-subtitle">Root cause analysis powered by LLM inference.</p>
    {% for analysis in failure_analyses %}
    <div class="analysis-item">
        <h4>{{ analysis.test_name }}</h4>
        <div class="analysis-field">
            <span class="field-label">Likely Cause</span>
            <span class="field-value">{{ analysis.likely_cause }}</span>
        </div>
        {% if analysis.suspected_file %}
        <div class="analysis-field">
            <span class="field-label">Suspected File</span>
            <span class="field-value"><code>{{ analysis.suspected_file }}</code></span>
        </div>
        {% endif %}
        {% if analysis.suspected_commit %}
        <div class="analysis-field">
            <span class="field-label">Suspected Commit</span>
            <span class="field-value"><code>{{ analysis.suspected_commit }}</code></span>
        </div>
        {% endif %}
        {% if analysis.explanation %}
        <div class="analysis-field">
            <span class="field-label">Explanation</span>
            <span class="field-value">{{ analysis.explanation }}</span>
        </div>
        {% endif %}
        {% if analysis.suggested_fix %}
        <div class="analysis-field">
            <span class="field-label">Suggested Fix</span>
            <span class="field-value">{{ analysis.suggested_fix }}</span>
        </div>
        {% endif %}
        <div class="analysis-field">
            <span class="field-label">Confidence</span>
            <span class="confidence">{{ "%.0f" | format(analysis.confidence * 100) }}%</span>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Recent Commits -->
{% if recent_commits %}
<div class="section collapsible">
    <h2 class="section-title">
        Recent Commits
        <span class="badge">{{ recent_commits | length }}</span>
        <span class="chevron">&#9654;</span>
    </h2>
    <div class="collapsible-body">
        {% for commit in recent_commits %}
        <div class="commit-row">
            <span class="commit-sha">{{ commit.short_hash }}</span>
            <span class="commit-msg">{{ commit.message | truncate(100) }}</span>
            <span class="commit-info">{{ commit.author }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Changed Files -->
{% if changed_files %}
<div class="section collapsible">
    <h2 class="section-title">
        Changed Files
        <span class="badge">{{ changed_files | length }}</span>
        <span class="chevron">&#9654;</span>
    </h2>
    <div class="collapsible-body">
        <div class="file-grid">
            {% for file in changed_files %}
            <span class="file-tag {% if file.change_type == 'A' %}added{% elif file.change_type == 'M' %}modified{% elif file.change_type == 'D' %}deleted{% endif %}">
                {{ file.path }}
            </span>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Untracked Files -->
{% if untracked_files %}
<div class="section collapsible">
    <h2 class="section-title">
        Untracked Files
        <span class="badge">{{ untracked_files | length }}</span>
        <span class="chevron">&#9654;</span>
    </h2>
    <div class="collapsible-body">
        <div class="file-grid">
            {% for file in untracked_files %}
            <span class="file-tag untracked">{{ file.path }}</span>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Passed Tests -->
{% if passed_tests %}
<div class="section collapsible">
    <h2 class="section-title">
        Passed Tests
        <span class="badge" style="background: var(--green-subtle); color: var(--green-text);">{{ passed_tests | length }}</span>
        <span class="chevron">&#9654;</span>
    </h2>
    <div class="collapsible-body">
        {% for test in passed_tests %}
        <div class="card">
            <div class="card-header" style="cursor: default;">
                <span class="card-name">{{ test.test_name }}</span>
                <div class="card-meta">
                    {% if test.duration_ms %}
                    <span class="card-duration">{{ test.duration_ms | duration_format }}</span>
                    {% endif %}
                    <span class="pill passed">Passed</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Skipped Tests -->
{% if skipped_tests %}
<div class="section collapsible">
    <h2 class="section-title">
        Skipped Tests
        <span class="badge" style="background: var(--amber-subtle); color: var(--amber-text);">{{ skipped_tests | length }}</span>
        <span class="chevron">&#9654;</span>
    </h2>
    <div class="collapsible-body">
        {% for test in skipped_tests %}
        <div class="card">
            <div class="card-header" style="cursor: default;">
                <span class="card-name">{{ test.test_name }}</span>
                <div class="card-meta">
                    <span class="pill skipped">Skipped</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Raw Output -->
{% if raw_output %}
<div class="section collapsible">
    <h2 class="section-title">
        Raw Test Output
        <span class="chevron">&#9654;</span>
    </h2>
    <div class="collapsible-body">
        <pre class="code-block">{{ raw_output }}</pre>
    </div>
</div>
{% endif %}

<footer>
    <p><span class="brand">TestRunner</span> v{{ "0.1.0" }}</p>
    <p>Language-agnostic test execution with LLM-powered failure analysis</p>
</footer>
{% endblock %}
